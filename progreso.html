<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Lecciones - UCDM</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #fbf5e2;
            color: #0c2f5b;
            transition: opacity 0.5s ease-in-out;
            overflow-x: hidden; /* Prevent horizontal scroll from fireworks */
        }
        .progress-section {
            position: relative;
            z-index: 5;
            padding-bottom: 50px;
        }
        .progress-container {
            position: relative;
            margin-top: 1.5rem;
            margin-bottom: 2rem;
            padding-top: 20px;
        }
        .progress-bar-bg { background-color: #e0d9c6; }
        .progress-bar-fg {
            background-image: linear-gradient(to right, #00bcd4, #e91e63);
            transition: width 0.5s ease-out;
        }
        .lesson-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 0.75rem;
        }
        .lesson-item {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 60px;
            border: 2px solid #e0d9c6;
            border-radius: 0.5rem;
            font-weight: 700;
            font-size: 1.125rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #ffffff;
            color: #0c2f5b;
            overflow: hidden;  
        }
        .lesson-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .lesson-item.completed {
            background-color: #fff8e1;
            color: #b8860b;
            border-color: #ffd700;
            box-shadow: 0 0 15px 5px rgba(255, 215, 0, 0.5);
        }
        .lesson-item .line-through {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 141%; 
            height: 3px;
            background: linear-gradient(to right, #00bcd4, #e91e63);
            transform: translate(-50%, -50%) rotate(-45deg) scaleX(0);
            transform-origin: center;
        }
        .lesson-item.completed .line-through {
            animation: draw-line 0.6s ease-out forwards;
        }
        @keyframes draw-line {
            from { transform: translate(-50%, -50%) rotate(-45deg) scaleX(0); }
            to { transform: translate(-50%, -50%) rotate(-45deg) scaleX(1); }
        }
        .info-note {
            background-color: #e6f7ff;
            border-left: 4px solid #00bcd4;
            color: #0c2f5b;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: #fffaf0;
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            position: relative;
        }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            font-size: 2rem;
            color: #9ca3af;
            cursor: pointer;
            line-height: 1;
        }
        .btn-primary {
            background-color: #e91e63;
            color: white;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover { background-color: #c2185b; }
        .btn-primary:disabled {
            background-color: #f8bbd0;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #e0e0e0;
            color: #333;
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover { background-color: #bdbdbd; }
        .btn-back {
            background-color: transparent;
            color: #0c2f5b;
            border: 2px solid #0c2f5b;
            transition: all 0.3s ease;
        }
        .btn-back:hover {
            background-color: #0c2f5b;
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .text-brand-green { color: #00bcd4; }
        .text-brand-pink { color: #e91e63; }
        .group-title {
            border-left: 4px solid #e91e63;
            padding-left: 1rem;
            margin-top: 3rem;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body class="antialiased" style="opacity: 0; visibility: hidden;">

    <audio id="completion-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-positive-notification-951.mp3" type="audio/mpeg">
    </audio>

    <div id="lesson-modal" class="modal-overlay">
        <div class="modal-content">
            <span id="modal-close" class="modal-close-btn">&times;</span>
            <h3 id="modal-lesson-number" class="text-sm font-bold tracking-widest uppercase mb-2"></h3>
            <p id="modal-lesson-phrase" class="text-2xl italic text-brand-green font-bold mb-4"></p>
            <p id="modal-lesson-explanation" class="text-gray-700 mb-6"></p>
            <div id="modal-exercise-container" class="mt-6 pt-4 border-t-2 border-dashed border-pink-200">
                <h4 class="font-bold text-brand-pink">Ejercicio Recomendado:</h4>
                <p id="modal-lesson-exercise" class="mt-2 text-gray-600"></p>
            </div>
            <div class="mt-8 text-center">
                 <button id="modal-complete-btn" class="btn-primary font-bold py-2 px-6 rounded-lg shadow-md">
                    Marcar como completada
                </button>
            </div>
        </div>
    </div>

    <div id="name-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-center mb-4">¡Bienvenido/a!</h3>
            <p class="text-center text-gray-700 mb-6">Por favor, introduce tu nombre para personalizar tu seguimiento y guardar tu progreso en la nube.</p>
            <div class="flex flex-col gap-4">
                <input type="text" id="name-input" placeholder="Tu nombre" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400">
                <button id="name-submit-btn" class="btn-primary font-bold py-2 px-6 rounded-lg shadow-md">Guardar y Empezar</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="confirm-title" class="text-xl font-bold text-center mb-4">Confirmar Acción</h3>
            <p id="confirm-message" class="text-center text-gray-700 mb-8"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-no-btn" class="btn-secondary font-bold py-2 px-6 rounded-lg">Cancelar</button>
                <button id="confirm-yes-btn" class="btn-primary font-bold py-2 px-6 rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="main-content" style="display: none;">
        <div class="max-w-4xl mx-auto p-4 md:p-8">
            <header class="mb-12">
                <img src="https://i.imgur.com/7CzZqwX.png" alt="Banner de la Membresía" class="w-full h-auto rounded-lg shadow-lg" onerror="this.onerror=null; this.src='https://placehold.co/1024x256/fbf5e2/0c2f5b?text=Banner+Membres%C3%ADa';">
            </header>

            <div class="text-center mb-12">
                <a href="./miembros.html" class="btn-back font-semibold py-2 px-5 rounded-lg no-underline inline-block">
                    &larr; Volver al panel de miembros
                </a>
            </div>

            <section class="mb-12">
                <h1 id="user-title" class="text-4xl md:text-5xl font-bold mb-2 text-center">Mi Progreso en las Lecciones</h1>
                <p class="text-lg text-gray-700 max-w-3xl mx-auto text-center mb-8">
                    Haz clic en cada lección para leer su contenido y márcala como completada. Tu progreso se guardará automáticamente en la nube.
                </p>
                
                <div class="mb-6 progress-section">
                    <div class="flex justify-between items-center mb-1 text-sm font-bold">
                        <span id="progress-text">0 / 0 Completadas</span>
                        <span id="progress-percent">0%</span>
                    </div>
                    <div class="progress-container">
                        <div class="w-full progress-bar-bg rounded-full h-4">
                            <div id="progress-bar" class="progress-bar-fg h-4 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div id="lesson-groups-container">
                     <p class="text-center p-8">Cargando estructura del curso...</p>
                </div>
            </section>
            
            <div class="text-center mt-8 flex justify-center gap-4 flex-wrap">
                <button id="reset-progress-btn" class="bg-gray-400 hover:bg-gray-500 text-gray-800 font-bold py-2 px-4 rounded-lg text-sm">
                    <i class="fas fa-undo mr-2"></i>Reiniciar progreso
                </button>
            </div>
        </div>
    </div>

    <div id="auth-message" class="max-w-4xl mx-auto p-8 text-center" style="display: none;">
        <h1 class="text-3xl font-bold text-red-600 mb-4">Acceso Denegado</h1>
        <p class="text-lg mt-4">Necesitas iniciar sesión para ver este contenido.</p>
        <a href="./login.html" class="mt-8 inline-block btn btn-pink font-bold py-3 px-6 rounded-lg">
            Ir a Iniciar Sesión
        </a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBbA-qi5YMot_55vqQ2KbocDwNMT8RNZ6Q",
            authDomain: "membresia-ucdm-v2.firebaseapp.com",
            projectId: "membresia-ucdm-v2",
            storageBucket: "membresia-ucdm-v2.firebasestorage.app",
            messagingSenderId: "198704348819",
            appId: "1:198704348819:web:4f52c9acf6cad3583e5766",
            measurementId: "G-5L3T8PGXYK"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const mainContent = document.getElementById('main-content');
        const authMessage = document.getElementById('auth-message');
        const groupsContainer = document.getElementById('lesson-groups-container');
        const progressText = document.getElementById('progress-text');
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');
        const resetBtn = document.getElementById('reset-progress-btn');
        const userTitle = document.getElementById('user-title');
        const soundEffect = document.getElementById('completion-sound');
        
        const lessonModal = document.getElementById('lesson-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLessonNum = document.getElementById('modal-lesson-number');
        const modalPhrase = document.getElementById('modal-lesson-phrase');
        const modalExplanation = document.getElementById('modal-lesson-explanation');
        const modalExerciseContainer = document.getElementById('modal-exercise-container');
        const modalExercise = document.getElementById('modal-lesson-exercise');
        const modalCompleteBtn = document.getElementById('modal-complete-btn');

        const nameModal = document.getElementById('name-modal');
        const nameInput = document.getElementById('name-input');
        const nameSubmitBtn = document.getElementById('name-submit-btn');

        const confirmModal = document.getElementById('confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');

        let courseStructure = [];
        let allLessonsMap = new Map();
        let completedLessons = new Set();
        let currentLessonId = null;
        let audioInitialized = false;
        let confirmCallback = null;
        
        let progressDocRef;
        let progressUnsubscribe;

        // --- Data Structure Setup ---
        function setupCourseStructure() {
            // --- CAMBIO CLAVE: Se han insertado los datos completos del CSV ---
            const rawData = `Nº de Lección/Ejercicio,Título/Frase del día,Explicación,Ejercicio
Introducción,"La manera en que ahora ves, tendrá que ser anulada",,
1,"Nada de lo que veo en esta habitación [en esta calle, desde esta ventana, en este lugar] significa nada.","Ahora mira lentamente a tu alrededor, y aplica esta idea de una manera muy específica a todo lo que veas:","Esa mesa no significa nada. Esa silla no significa nada. Esta mano no significa nada. Este pie no significa nada. Esta pluma no significa nada."
2,"Le he dado a todo lo que veo en esta habitación [en esta calle, desde esta ventana, en este lugar] todo el significado que tiene para mí.","Los ejercicios deben hacerse con los ojos abiertos.","Aplica la idea a cualquier cosa que veas, usando el nombre del objeto en cuestión y manteniendo la mirada en él mientras dices: “Le he dado a este/a ______ todo el significado que tiene para mí”."
3,"No entiendo nada de lo que veo en esta habitación [en esta calle, desde esta ventana, en este lugar].","Esta idea, al igual que la anterior, debe aplicarse a todo lo que veas indiscriminadamente.","Aplica la idea a cualquier cosa que veas, usando el nombre del objeto en cuestión y manteniendo la mirada en él mientras dices: “No entiendo este/a ______”."
4,"Estos pensamientos no significan nada. Son como las cosas que veo en esta habitación [en esta calle, desde esta ventana, en este lugar].","A diferencia de los ejercicios anteriores, éstos no se hacen con los ojos abiertos.","Con los ojos cerrados, aplica la idea a cualquier pensamiento que se te ocurra, usando el nombre del pensamiento en cuestión y manteniendo tu mente en él mientras dices: “Este pensamiento acerca de ______ no significa nada”."
5,"Nunca estoy disgustado por la razón que creo.","Esta idea, al igual que la anterior, puede aplicarse a cualquier persona, situación o acontecimiento que creas que te está causando dolor.","Aplica la idea a cualquier cosa que creas que te está causando dolor, usando el nombre de la persona, situación o acontecimiento en cuestión y diciendo: “Nunca estoy disgustado por la razón que creo”."
6,"Estoy disgustado porque veo algo que no está ahí.","Esta idea es muy similar a la anterior, y puede aplicarse a cualquier persona, situación o acontecimiento que creas que te está causando dolor.","Aplica la idea a cualquier cosa que creas que te está causando dolor, usando el nombre de la persona, situación o acontecimiento en cuestión y diciendo: “Estoy disgustado porque veo algo que no está ahí”."
7,"Sólo veo el pasado.","Esta idea es particularmente difícil de creer al principio, pero es la razón fundamental de todas las anteriores.","Aplica la idea a cualquier cosa que veas, usando el nombre del objeto en cuestión y manteniendo la mirada en él mientras dices: “Sólo veo el pasado en este/a ______”."
8,"Mi mente está absorbida con pensamientos del pasado.","Esta idea es, por supuesto, la razón de que veas únicamente el pasado.","Con los ojos cerrados, aplica la idea a cualquier pensamiento que se te ocurra, usando el nombre del pensamiento en cuestión y manteniendo tu mente en él mientras dices: “Mi mente está absorbida con pensamientos del pasado acerca de ______”."
9,"No veo nada tal como es ahora.","Esta idea es la consecuencia lógica de las dos anteriores.","Aplica la idea a cualquier cosa que veas, usando el nombre del objeto en cuestión y manteniendo la mirada en él mientras dices: “No veo este/a ______ tal como es ahora”."
10,"Mis pensamientos no significan nada.","Esta idea es aplicable a todos los pensamientos de los que eres o te vuelves consciente durante las sesiones de práctica.","Con los ojos cerrados, aplica la idea a cualquier pensamiento que se te ocurra, usando el nombre del pensamiento en cuestión y manteniendo tu mente en él mientras dices: “Mi pensamiento acerca de ______ no significa nada”."
11,"Mis pensamientos sin significado me están mostrando un mundo sin significado.","Esta idea es la primera que está relacionada con una de las fases principales del proceso de corrección: el reconocimiento de la causa y el efecto.","Aplica la idea a cualquier pensamiento que se te ocurra, usando el nombre del pensamiento en cuestión y manteniendo tu mente en él mientras dices: “Mi pensamiento acerca de ______ me está mostrando un mundo sin significado”."
12,"Estoy disgustado porque veo un mundo que no tiene significado.","Esta idea es la continuación de la anterior.","Aplica la idea a cualquier pensamiento que se te ocurra, usando el nombre del pensamiento en cuestión y manteniendo tu mente en él mientras dices: “Estoy disgustado porque veo un mundo que no tiene significado”."
13,"Un mundo sin significado engendra temor.","Esta idea es realmente una variación de la anterior.","Aplica la idea a cualquier pensamiento que se te ocurra, usando el nombre del pensamiento en cuestión y manteniendo tu mente en él mientras dices: “Un mundo sin significado engendra temor”."
14,"Dios no creó un mundo sin significado.","Esta idea es nuestro primer intento de aprender a negar lo que es falso y a aceptar lo que es verdadero.","Aplica la idea a cualquier pensamiento que se te ocurra, usando el nombre del pensamiento en cuestión y manteniendo tu mente en él mientras dices: “Dios no creó un mundo sin significado”."
15,"Mis pensamientos son imágenes que yo mismo he fabricado.","Esta idea es el primer paso para aprender a ver.","Con los ojos cerrados, aplica la idea a cualquier pensamiento que se te ocurra, usando el nombre del pensamiento en cuestión y manteniendo tu mente en él mientras dices: “Mi pensamiento acerca de ______ es una imagen que yo mismo he fabricado”."
16,"No tengo pensamientos neutros.","Esta idea es un paso inicial en el proceso de desvanecer la creencia de que tus pensamientos no tienen ningún efecto.","Con los ojos cerrados, aplica la idea a cualquier pensamiento que se te ocurra, usando el nombre del pensamiento en cuestión y manteniendo tu mente en él mientras dices: “Mi pensamiento acerca de ______ no es un pensamiento neutro”."
17,"No veo cosas neutras.","Esta idea es otro paso en el proceso de identificar causa y efecto tal como realmente operan en el mundo.","Aplica la idea a cualquier cosa que veas, usando el nombre del objeto en cuestión y manteniendo la mirada en él mientras dices: “No veo un/a ______ neutro/a”."
18,"No soy el único que experimenta los efectos de mi manera de ver.","Esta idea es un paso más en el proceso de aprender que tus pensamientos tienen poder.","Aplica la idea a cualquier cosa que veas, usando el nombre del objeto en cuestión y manteniendo la mirada en él mientras dices: “No soy el único que experimenta los efectos de mi manera de ver este/a ______”."
19,"No soy el único que experimenta los efectos de mis pensamientos.","Esta idea es la que te permitirá finalmente entender que no hay separación.","Con los ojos cerrados, aplica la idea a cualquier pensamiento que se te ocurra, usando el nombre del pensamiento en cuestión y manteniendo tu mente en él mientras dices: “No soy el único que experimenta los efectos de mi pensamiento acerca de ______”."
20,"Estoy decidido a ver.","Esta idea es una declaración de tu voluntad de cambiar.","Aplica la idea a cualquier cosa que veas, usando el nombre del objeto en cuestión y manteniendo la mirada en él mientras dices: “Estoy decidido a ver este/a ______”."
21,"Estoy decidido a ver las cosas de otra manera.","Esta idea es, obviamente, una continuación y ampliación de la anterior.","Aplica la idea a cualquier cosa que veas, usando el nombre del objeto en cuestión y manteniendo la mirada en él mientras dices: “Estoy decidido a ver este/a ______ de otra manera”."
22,"Lo que veo es una forma de venganza.","Esta idea describe con gran precisión lo que realmente ves.","Aplica la idea a cualquier cosa que veas, usando el nombre del objeto en cuestión y manteniendo la mirada en él mientras dices: “Veo una forma de venganza en este/a ______”."
23,"Puedo escaparme de este mundo que veo renunciando a los pensamientos de ataque.","Esta idea contiene la única vía de escape del miedo que jamás tendrá éxito.","Con los ojos cerrados, aplica la idea a cualquier pensamiento de ataque que se te ocurra, usando el nombre del pensamiento en cuestión y manteniendo tu mente en él mientras dices: “Puedo escaparme de este mundo que veo renunciando a los pensamientos de ataque acerca de ______”."
24,"No percibo lo que más me conviene.","Esta idea es el trampolín para la inversión del pensamiento.","Aplica la idea a cualquier situación en la que te encuentres, usando el nombre de la situación en cuestión y manteniendo tu mente en ella mientras dices: “No percibo lo que más me conviene en esta situación”."
25,"No sé cuál es el propósito de nada.","Esta idea es una extensión de la anterior.","Aplica la idea a cualquier cosa que veas, usando el nombre del objeto en cuestión y manteniendo la mirada en él mientras dices: “No sé cuál es el propósito de este/a ______”."
26,"Mis pensamientos de ataque atacan mi invulnerabilidad.","Esta idea te ayudará a entender que el ataque es autodestrucción.","Con los ojos cerrados, aplica la idea a cualquier pensamiento de ataque que se te ocurra, usando el nombre del pensamiento en cuestión y manteniendo tu mente en él mientras dices: “Mi pensamiento de ataque acerca de ______ ataca mi invulnerabilidad”."
27,"Por encima de todo quiero ver.","Esta idea expresa algo más fuerte que una simple resolución.","Aplica la idea a cualquier cosa que veas, usando el nombre del objeto en cuestión y manteniendo la mirada en él mientras dices: “Por encima de todo quiero ver este/a ______”."
28,"Por encima de todo quiero ver las cosas de otra manera.","Esta idea es una continuación de la anterior.","Aplica la idea a cualquier cosa que veas, usando el nombre del objeto en cuestión y manteniendo la mirada en él mientras dices: “Por encima de todo quiero ver este/a ______ de otra manera”."
29,"Dios está en todo lo que veo.","Esta idea explica por qué puedes ver propósito en todo.","Aplica la idea a cualquier cosa que veas, usando el nombre del objeto en cuestión y manteniendo la mirada en él mientras dices: “Dios está en este/a ______”."
30,"Dios está en todo lo que veo porque Dios está en mi mente.","Esta idea es el trampolín a la visión.","Con los ojos cerrados, aplica la idea a cualquier pensamiento que se te ocurra, usando el nombre del pensamiento en cuestión y manteniendo tu mente en él mientras dices: “Dios está en mi pensamiento acerca de ______”."
31,"No soy víctima del mundo que veo.","Esta idea es la introducción a tu declaración de liberación.","Aplica la idea a cualquier cosa que veas, usando el nombre del objeto en cuestión y manteniendo la mirada en él mientras dices: “No soy víctima de este/a ______”."
32,"He inventado el mundo que veo.","Esta idea es la continuación de la anterior.","Con los ojos cerrados, aplica la idea a cualquier pensamiento que se te ocurra, usando el nombre del pensamiento en cuestión y manteniendo tu mente en él mientras dices: “He inventado mi pensamiento acerca de ______”."
33,"Hay otra manera de ver el mundo.","Esta idea es un intento de reconocer que puedes cambiar tu percepción del mundo tanto en su aspecto externo como interno.","Aplica la idea a cualquier cosa que veas, usando el nombre del objeto en cuestión y manteniendo la mirada en él mientras dices: “Hay otra manera de ver este/a ______”."
34,"Podría ver paz en lugar de esto.","Esta idea comienza a describir las condiciones que prevalecen en la otra manera de ver.","Aplica la idea a cualquier cosa que veas, usando el nombre del objeto en cuestión y manteniendo la mirada en él mientras dices: “Podría ver paz en este/a ______”."
35,"Mi mente es parte de la de Dios. Soy muy santo.","Esta idea no describe la manera en que te ves a ti mismo ahora.","Con los ojos cerrados, aplica la idea a cualquier pensamiento que se te ocurra, usando el nombre del pensamiento en cuestión y manteniendo tu mente en él mientras dices: “Mi pensamiento acerca de ______ es parte de la mente de Dios. Soy muy santo”."
36,"Mi santidad envuelve todo lo que veo.","Esta idea extiende la idea de ayer desde el perceptor a lo percibido.","Aplica la idea a cualquier cosa que veas, usando el nombre del objeto en cuestión y manteniendo la mirada en él mientras dices: “Mi santidad envuelve este/a ______”."
37,"Mi santidad bendice al mundo.","Esta idea contiene los primeros destellos de tu verdadera función en el mundo, o en otras palabras, la razón por la que estás aquí.","Aplica la idea a cualquier cosa que veas, usando el nombre del objeto en cuestión y manteniendo la mirada en él mientras dices: “Mi santidad bendice este/a ______”."
38,"No hay nada que mi santidad no pueda hacer.","Tu santidad invierte todas las leyes del mundo.","Con los ojos cerrados, aplica la idea a cualquier pensamiento que se te ocurra, usando el nombre del pensamiento en cuestión y manteniendo tu mente en él mientras dices: “No hay nada que mi santidad no pueda hacer en mi pensamiento acerca de ______”."
39,"Mi santidad es mi salvación.","Si la culpa es el infierno, ¿cuál es su opuesto?","Aplica la idea a cualquier pensamiento que se te ocurra, usando el nombre del pensamiento en cuestión y manteniendo tu mente en él mientras dices: “Mi santidad es mi salvación de mi pensamiento acerca de ______”."
40,"Soy bendito por ser un Hijo de Dios.","Esta idea es una afirmación de tu derecho a la santidad.","Aplica la idea a cualquier cosa que veas, usando el nombre del objeto en cuestión y manteniendo la mirada en él mientras dices: “Soy bendito por ser un Hijo de Dios en este/a ______”."
41,"Dios va conmigo dondequiera que yo voy.","Esta idea te ayudará a sentir la certeza de que no estás solo.","Con los ojos cerrados, aplica la idea a cualquier pensamiento que se te ocurra, usando el nombre del pensamiento en cuestión y manteniendo tu mente en él mientras dices: “Dios va conmigo en mi pensamiento acerca de ______”."
42,"Dios es mi fortaleza. La visión es Su don.","Esta idea combina dos pensamientos muy poderosos.","Aplica la idea a cualquier cosa que veas, usando el nombre del objeto en cuestión y manteniendo la mirada en él mientras dices: “Dios es mi fortaleza. La visión de este/a ______ es Su don”."
43,"Dios es mi Fuente. No puedo ver separado de Él.","La percepción no es un atributo de Dios.","Con los ojos cerrados, aplica la idea a cualquier pensamiento que se te ocurra, usando el nombre del pensamiento en cuestión y manteniendo tu mente en él mientras dices: “Dios es mi Fuente. No puedo pensar acerca de ______ separado de Él”."
44,"Dios es la luz en la que veo.","Esta idea es la inversión de 'veo en la oscuridad'.","Aplica la idea a cualquier cosa que veas, usando el nombre del objeto en cuestión y manteniendo la mirada en él mientras dices: “Dios es la luz en la que veo este/a ______”."
45,"Dios es la Mente con la que pienso.","Esta idea es la que finalmente te permitirá identificarte con la Mente de Dios.","Con los ojos cerrados, aplica la idea a cualquier pensamiento que se te ocurra, usando el nombre del pensamiento en cuestión y manteniendo tu mente en él mientras dices: “Dios es la Mente con la que pienso acerca de ______”."
46,"Dios es el Amor en el que perdono.","Dios no perdona porque nunca ha condenado.","Aplica la idea a cualquier cosa que veas, usando el nombre del objeto en cuestión y manteniendo la mirada en él mientras dices: “Dios es el Amor en el que perdono a este/a ______”."
47,"Dios es la fortaleza en la que confío.","Si confías en tu propia fortaleza, tienes todas las razones para sentirte aprensivo, ansioso y temeroso.","Con los ojos cerrados, aplica la idea a cualquier pensamiento que se te ocurra, usando el nombre del pensamiento en cuestión y manteniendo tu mente en él mientras dices: “Dios es la fortaleza en la que confío acerca de ______”."
`;

            const allRows = rawData.split('\n').filter(row => row.trim() !== '').slice(1);
            let currentGroup = null;

            allRows.forEach(row => {
                const [id, title, explanation, exercise] = parseCsvRow(row);
                
                // --- CAMBIO CLAVE: Comprobación para evitar errores ---
                if (!id) return;

                const isGroupTitle = isNaN(parseInt(id, 10));
                
                const lessonData = {
                    id: (id || '').trim(),
                    title: (title || '').trim(),
                    explanation: (explanation || '').trim(),
                    exercise: (exercise || '').trim(),
                    type: isGroupTitle ? 'group_title' : 'lesson'
                };

                allLessonsMap.set(lessonData.id, lessonData);

                if (isGroupTitle) {
                    currentGroup = {
                        title: lessonData.title,
                        lessons: []
                    };
                    courseStructure.push(currentGroup);
                } else if (currentGroup) {
                    currentGroup.lessons.push(lessonData);
                }
            });
            renderCourse();
        }

        function parseCsvRow(row) {
            const parts = [];
            let current = '';
            let inQuotes = false;
            for (const char of row) {
                if (char === '"' && (current.length === 0 || current.slice(-1) !== '\\')) {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    parts.push(current.replace(/\\"/g, '"'));
                    current = '';
                } else {
                    current += char;
                }
            }
            parts.push(current.replace(/\\"/g, '"'));
            return parts.map(item => item.trim().replace(/^"|"$/g, ''));
        }

        function renderCourse() {
            groupsContainer.innerHTML = '';
            courseStructure.forEach(group => {
                const groupContainer = document.createElement('div');
                const titleEl = document.createElement('h3');
                titleEl.className = 'text-2xl font-bold group-title';
                titleEl.textContent = group.title;
                groupContainer.appendChild(titleEl);

                const grid = document.createElement('div');
                grid.className = 'lesson-grid';
                group.lessons.forEach(lesson => {
                    const lessonItem = document.createElement('div');
                    lessonItem.className = 'lesson-item';
                    lessonItem.textContent = lesson.id;
                    lessonItem.dataset.id = lesson.id;
                    lessonItem.innerHTML += '<div class="line-through"></div>';
                    lessonItem.addEventListener('click', () => openLessonModal(lesson.id));
                    grid.appendChild(lessonItem);
                });
                groupContainer.appendChild(grid);
                groupsContainer.appendChild(groupContainer);
            });
            updateUI();
        }

        // --- Auth & Firestore Logic ---
        onAuthStateChanged(auth, user => {
            document.body.style.opacity = '1';
            document.body.style.visibility = 'visible';

            if (user) {
                mainContent.style.display = 'block';
                authMessage.style.display = 'none';
                
                const userId = user.uid;
                const userDocRef = doc(db, "users", userId);
                onSnapshot(userDocRef, (docSnap) => {
                    if(docSnap.exists() && docSnap.data().name) {
                        userTitle.textContent = `El Progreso de ${docSnap.data().name}`;
                    }
                });

                const appId = 'ucdm-tracker-app-v2'; // Using a new ID for the new structure
                progressDocRef = doc(db, 'artifacts', appId, 'users', userId, 'progress', 'main');
                
                if (progressUnsubscribe) progressUnsubscribe();
                
                progressUnsubscribe = onSnapshot(progressDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        completedLessons = new Set(data.completed || []);
                        closeNameModal();
                        updateUI();
                    } else {
                        showNameModal();
                    }
                }, (error) => {
                    console.error("Error en el listener de progreso:", error);
                    groupsContainer.innerHTML = `<p class="col-span-full text-center p-8 text-red-500">Error al cargar tu progreso.</p>`;
                });

            } else {
                mainContent.style.display = 'none';
                authMessage.style.display = 'block';
            }
        });

        // --- UI Update & Interaction Logic ---
        function updateUI() {
            updateProgress();
            updateLessonItemsState();
        }

        function updateProgress() {
            const totalLessonCount = allLessonsMap.size;
            const completedCount = completedLessons.size;
            const percentage = totalLessonCount > 0 ? (completedCount / totalLessonCount) * 100 : 0;
            
            progressText.textContent = `${completedCount} / ${totalLessonCount} Completadas`;
            progressBar.style.width = `${percentage}%`;
            progressPercent.textContent = `${Math.round(percentage)}%`;
        }

        function updateLessonItemsState() {
            allLessonsMap.forEach(lesson => {
                const item = document.querySelector(`.lesson-item[data-id='${lesson.id}']`);
                if (item) {
                    item.classList.toggle('completed', completedLessons.has(lesson.id));
                }
            });
        }
        
        function openLessonModal(lessonId) {
            initializeAudio(); 
            currentLessonId = lessonId;
            const lesson = allLessonsMap.get(lessonId);
            
            if (!lesson) return;

            modalLessonNum.textContent = lesson.type === 'lesson' ? `Lección ${lesson.id}` : 'Introducción';
            modalPhrase.textContent = `“${lesson.title}”`;
            modalExplanation.textContent = lesson.explanation;
            
            if (lesson.exercise && lesson.exercise.trim() !== '') {
                modalExercise.textContent = lesson.exercise;
                modalExerciseContainer.style.display = 'block';
            } else {
                modalExerciseContainer.style.display = 'none';
            }
            
            modalCompleteBtn.textContent = completedLessons.has(lessonId) ? 'Marcar como pendiente' : 'Marcar como completada';
            lessonModal.classList.add('show');
        }
        
        async function handleMarkComplete() {
            if (currentLessonId === null) return;
            
            const newCompletedSet = new Set(completedLessons);
            if (newCompletedSet.has(currentLessonId)) {
                newCompletedSet.delete(currentLessonId);
            } else {
                newCompletedSet.add(currentLessonId);
                playCompletionSound();
            }

            if (progressDocRef) {
                try {
                    await updateDoc(progressDocRef, { completed: [...newCompletedSet] });
                } catch (error) {
                    console.error("Error updating progress:", error);
                    showConfirmation(`Hubo un error al guardar tu progreso: ${error.message}`, null);
                }
            }
            closeLessonModal();
        }

        async function handleNameSubmit() {
            const newName = nameInput.value.trim();
            if (!newName || !auth.currentUser || !progressDocRef) return;

            nameSubmitBtn.disabled = true;
            nameSubmitBtn.textContent = 'Guardando...';

            const userId = auth.currentUser.uid;
            const userDocRef = doc(db, "users", userId);
            try {
                await Promise.all([
                    setDoc(userDocRef, { name: newName }, { merge: true }),
                    setDoc(progressDocRef, { userName: newName, completed: [] })
                ]);
                closeNameModal(); 
            } catch (error) {
                console.error("Error saving initial data:", error);
                alert("No se pudo guardar tu nombre. Por favor, inténtalo de nuevo.");
            } finally {
                nameSubmitBtn.disabled = false;
                nameSubmitBtn.textContent = 'Guardar y Empezar';
            }
        }

        function handleResetProgress() {
            showConfirmation('¿Estás seguro de que quieres reiniciar todo tu progreso? Esta acción no se puede deshacer.', async () => {
                if (progressDocRef) {
                    try {
                        await updateDoc(progressDocRef, { completed: [] });
                    } catch (error) {
                        console.error("Error resetting progress:", error);
                        showConfirmation(`Hubo un error al reiniciar: ${error.message}`, null);
                    }
                }
            });
        }

        function initializeAudio() {
            if (audioInitialized) return;
            soundEffect.play().then(() => soundEffect.pause()).catch(() => {});
            audioInitialized = true;
        }

        function playCompletionSound() {
            if (soundEffect) {
                soundEffect.currentTime = 0;
                soundEffect.play().catch(e => console.error("Error playing sound:", e));
            }
        }

        function closeLessonModal() { lessonModal.classList.remove('show'); }
        function showNameModal() { nameModal.classList.add('show'); }
        function closeNameModal() { nameModal.classList.remove('show'); }
        
        function showConfirmation(message, onConfirm) {
            confirmMessage.textContent = message;
            confirmCallback = onConfirm;
            confirmModal.classList.add('show');
        }

        function closeConfirmModal() {
            confirmModal.classList.remove('show');
            confirmCallback = null;
        }

        // --- Event Listeners ---
        modalCloseBtn.addEventListener('click', closeLessonModal);
        lessonModal.addEventListener('click', (e) => e.target === lessonModal && closeLessonModal());
        modalCompleteBtn.addEventListener('click', handleMarkComplete);
        nameSubmitBtn.addEventListener('click', handleNameSubmit);
        nameInput.addEventListener('keyup', (e) => e.key === 'Enter' && handleNameSubmit());
        confirmYesBtn.addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            closeConfirmModal();
        });
        confirmNoBtn.addEventListener('click', closeConfirmModal);
        resetBtn.addEventListener('click', handleResetProgress);
        
        // --- Start Application ---
        setupCourseStructure();
    </script>
</body>
</html>
